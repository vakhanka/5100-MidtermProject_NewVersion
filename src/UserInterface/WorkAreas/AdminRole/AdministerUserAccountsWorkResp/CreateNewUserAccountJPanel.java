/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package UserInterface.WorkAreas.AdminRole.AdministerUserAccountsWorkResp;

import Business.Business;
import Business.Person.Person;
import Business.Person.PersonDirectory;
import Business.Profiles.EmployeeDirectory;
import Business.Profiles.EmployeeProfile;
import Business.Profiles.RegistrarProfile;
import Business.Profiles.StudentProfile;
import Business.UserAccounts.UserAccount;
import Business.UserAccounts.UserAccountDirectory;
import java.util.Arrays;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import Business.Profiles.StudentDirectory;

/**
 *
 * @author kal bugrara
 */
public class CreateNewUserAccountJPanel extends javax.swing.JPanel {

    /**
     * Creates new form ManageSuppliersJPanel
     */
    JPanel CardSequencePanel;
    Business business;


    public CreateNewUserAccountJPanel(Business bz, JPanel jp) {
        CardSequencePanel = jp;
        this.business = bz;
        initComponents();

    }


    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lblPageTitle = new javax.swing.JLabel();
        btnBack = new javax.swing.JButton();
        txtUsername = new javax.swing.JTextField();
        btnSave = new javax.swing.JButton();
        lblName = new javax.swing.JLabel();
        lblUsername = new javax.swing.JLabel();
        txtPhone = new javax.swing.JTextField();
        btnEdit = new javax.swing.JButton();
        lblProfileType = new javax.swing.JLabel();
        cbxRole = new javax.swing.JComboBox<>();
        pwPassword = new javax.swing.JPasswordField();
        lblPassword = new javax.swing.JLabel();
        lblConfirmPassword = new javax.swing.JLabel();
        pwConfirmPassword = new javax.swing.JPasswordField();
        lblName1 = new javax.swing.JLabel();
        lblName2 = new javax.swing.JLabel();
        txtEmail = new javax.swing.JTextField();
        txtName2 = new javax.swing.JTextField();

        setBackground(new java.awt.Color(0, 153, 153));
        setLayout(null);

        lblPageTitle.setFont(new java.awt.Font("Arial", 0, 24)); // NOI18N
        lblPageTitle.setText("Create New User Account");
        add(lblPageTitle);
        lblPageTitle.setBounds(21, 20, 550, 28);

        btnBack.setText("<< Back");
        btnBack.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnBackActionPerformed(evt);
            }
        });
        add(btnBack);
        btnBack.setBounds(40, 420, 100, 23);
        add(txtUsername);
        txtUsername.setBounds(440, 90, 140, 30);

        btnSave.setText("Save");
        btnSave.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSaveActionPerformed(evt);
            }
        });
        add(btnSave);
        btnSave.setBounds(350, 420, 72, 20);

        lblName.setText("Phone");
        add(lblName);
        lblName.setBounds(60, 250, 50, 20);

        lblUsername.setText("Username");
        add(lblUsername);
        lblUsername.setBounds(370, 100, 70, 20);
        add(txtPhone);
        txtPhone.setBounds(110, 240, 140, 30);

        btnEdit.setText("Clear");
        btnEdit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnEditActionPerformed(evt);
            }
        });
        add(btnEdit);
        btnEdit.setBounds(520, 420, 80, 20);

        lblProfileType.setText("Profile Type");
        add(lblProfileType);
        lblProfileType.setBounds(30, 100, 80, 20);

        cbxRole.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Admin", "Registrar", "Faculty", "Student" }));
        add(cbxRole);
        cbxRole.setBounds(110, 90, 140, 30);
        add(pwPassword);
        pwPassword.setBounds(440, 140, 140, 30);

        lblPassword.setText("Password");
        add(lblPassword);
        lblPassword.setBounds(370, 150, 70, 20);

        lblConfirmPassword.setText("Confirm Password ");
        add(lblConfirmPassword);
        lblConfirmPassword.setBounds(330, 200, 110, 20);
        add(pwConfirmPassword);
        pwConfirmPassword.setBounds(440, 190, 140, 30);

        lblName1.setText("Email");
        add(lblName1);
        lblName1.setBounds(60, 200, 50, 20);

        lblName2.setText("Name");
        add(lblName2);
        lblName2.setBounds(60, 150, 50, 20);
        add(txtEmail);
        txtEmail.setBounds(110, 190, 140, 30);
        add(txtName2);
        txtName2.setBounds(110, 140, 140, 30);
    }// </editor-fold>//GEN-END:initComponents

    private void btnBackActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnBackActionPerformed
        // TODO add your handling code here:
        CardSequencePanel.remove(this);
        ((java.awt.CardLayout) CardSequencePanel.getLayout()).next(CardSequencePanel);

    }//GEN-LAST:event_btnBackActionPerformed

    private void btnSaveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSaveActionPerformed
        // TODO add your handling code here:
        saveuser();
    }//GEN-LAST:event_btnSaveActionPerformed

    private void btnEditActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnEditActionPerformed
        // clear all fields
        clearfields();
    }//GEN-LAST:event_btnEditActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnBack;
    private javax.swing.JButton btnEdit;
    private javax.swing.JButton btnSave;
    private javax.swing.JComboBox<String> cbxRole;
    private javax.swing.JLabel lblConfirmPassword;
    private javax.swing.JLabel lblName;
    private javax.swing.JLabel lblName1;
    private javax.swing.JLabel lblName2;
    private javax.swing.JLabel lblPageTitle;
    private javax.swing.JLabel lblPassword;
    private javax.swing.JLabel lblProfileType;
    private javax.swing.JLabel lblUsername;
    private javax.swing.JPasswordField pwConfirmPassword;
    private javax.swing.JPasswordField pwPassword;
    private javax.swing.JTextField txtEmail;
    private javax.swing.JTextField txtName2;
    private javax.swing.JTextField txtPhone;
    private javax.swing.JTextField txtUsername;
    // End of variables declaration//GEN-END:variables

    private void saveuser() {
    // Extract values from fields
        String name = txtPhone.getText().trim();
        String username = txtUsername.getText().trim();
        String role = (String) cbxRole.getSelectedItem();
        char[] passwordChars = pwPassword.getPassword();
        char[] confirmChars = pwConfirmPassword.getPassword();
        String password = new String(passwordChars); // convert pw to String
        String email = txtEmail.getText().trim();
        String phone = txtPhone.getText().trim();
        
        
    // Perform all validations
    // Verify name, username, role are not blank
        if (role==null){
            JOptionPane.showMessageDialog(this, "Please select a role.");
            return;
        }
        
        if (name.isBlank() || username.isBlank() || email.isBlank()) {
            JOptionPane.showMessageDialog(this, "Name and Username and Email are required.");
            return;
        }
        
        if (passwordChars == null || passwordChars.length == 0) {
            JOptionPane.showMessageDialog(this, "Please enter a password.");
            return;
        }
    // Verify Passwords Match
        if (!Arrays.equals(passwordChars, confirmChars)) {
            JOptionPane.showMessageDialog(this, "Passwords don't match.");
            return;
        }
        
    // Verify username is available
        UserAccount u = business.getUserAccountDirectory().findusername(username);
        if (u!=null){
            JOptionPane.showMessageDialog(this, "Username is taken. Please select another username.");
            return;
        }
    
    

// Create new user account
    //Get the common directories    
        PersonDirectory pd = business.getPersonDirectory();
        UserAccountDirectory uad = business.getUserAccountDirectory(); 
        
    //Create Person
        Person np = pd.newPerson(name); // Create Person from Name Input
        if(role.equals("Student")){
            savestudentprofile(np, username, password);
        }else{
            saveemployeeprofile(np, username, password, role);
        }
    //Show Success Message
    JOptionPane.showMessageDialog(this, "User created successfully.");
    
    //Reset Fields
    clearfields();
    }

    private void clearfields() {
        txtPhone.setText("");
        txtUsername.setText("");
        pwPassword.setText("");
        txtPhone.setText("");
        cbxRole.setSelectedIndex(0);
        txtEmail.setText("");
        txtPhone.setText("");
    }    
        

    private void savestudentprofile(Person np, String username, String password) {
        StudentDirectory sd = business.getStudentDirectory();
        StudentProfile sp = sd.newStudentProfile(np);
        UserAccountDirectory uad = business.getUserAccountDirectory();
        UserAccount ua = uad.newUserAccount(sp, username, password);
    }

    private void saveemployeeprofile(Person np, String username, String password, String role) {
        EmployeeDirectory ed = business.getEmployeeDirectory();
        if(role.equals("Registrar")){     
            RegistrarProfile rp = ed.newRegistrarProfile(np);
            UserAccountDirectory uad = business.getUserAccountDirectory();
            UserAccount ua1 = uad.newUserAccount(rp, username, password);    
        } else if (role.equals("Admin")){
            EmployeeProfile ep = ed.newEmployeeProfile(np, "Admin");
            UserAccountDirectory uad = business.getUserAccountDirectory();
            UserAccount ua2 = uad.newUserAccount(ep, username, password);
        } //else if (role.equals("Faculty")){                                               TO DO when FacultyProfile is live
            //FacultyProfile fp = ed.newFacultyProfile(np);
            //UserAccountDirectory uad = business.getUserAccountDirectory();
            //UserAccount ua3 = uad.newUserAccount(fp, username, password); 
            
    }
        
    }

