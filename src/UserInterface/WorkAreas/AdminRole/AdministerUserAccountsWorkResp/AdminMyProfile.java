/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package UserInterface.WorkAreas.AdminRole.AdministerUserAccountsWorkResp;

import Business.Business;
import Business.Person.Person;
import Business.Profiles.EmployeeProfile;
import Business.UserAccounts.UserAccount;
import UserInterface.WorkAreas.AdminRole.ManagePersonnelWorkResp.ManageEmployeesJPanel;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import javax.swing.JOptionPane;
import javax.swing.JPanel;

/**
 *h
 * @author kal bugrara
 */

public class AdminMyProfile extends javax.swing.JPanel {


    JPanel CardSequencePanel;
    UserAccount selecteduseraccount;
    EmployeeProfile employeeprofile;
    Business business;
  

    public AdminMyProfile(UserAccount sua, JPanel jp, Business business) {

        this.CardSequencePanel = jp;
        this.selecteduseraccount= sua;
        this.employeeprofile = (EmployeeProfile)sua.getAssociatedPersonProfile();
        this.business = business;
        initComponents();
        populatefields();

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lblPageTitle = new javax.swing.JLabel();
        Back1 = new javax.swing.JButton();
        lblUsername = new javax.swing.JLabel();
        lblName = new javax.swing.JLabel();
        txtName = new javax.swing.JTextField();
        txtUsername = new javax.swing.JTextField();
        txtEmail = new javax.swing.JTextField();
        lblEmail = new javax.swing.JLabel();
        txtPhone = new javax.swing.JTextField();
        lblPhone = new javax.swing.JLabel();
        btnSave = new javax.swing.JButton();
        pwPassword = new javax.swing.JPasswordField();
        lblPassword = new javax.swing.JLabel();
        lblConfirmPassword = new javax.swing.JLabel();
        pwConfirmPassword = new javax.swing.JPasswordField();
        btnEdit = new javax.swing.JButton();
        txtCreated = new javax.swing.JTextField();
        lblCreated = new javax.swing.JLabel();
        btnSavePw = new javax.swing.JButton();
        btnResetPw = new javax.swing.JButton();

        setBackground(new java.awt.Color(0, 153, 153));
        setLayout(null);

        lblPageTitle.setFont(new java.awt.Font("Arial", 0, 24)); // NOI18N
        lblPageTitle.setText("My Profile");
        add(lblPageTitle);
        lblPageTitle.setBounds(21, 20, 550, 28);

        Back1.setText("<< Back");
        Back1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                Back1ActionPerformed(evt);
            }
        });
        add(Back1);
        Back1.setBounds(20, 420, 100, 23);

        lblUsername.setText("Username:");
        add(lblUsername);
        lblUsername.setBounds(40, 120, 170, 30);

        lblName.setText("Name:");
        add(lblName);
        lblName.setBounds(40, 80, 170, 30);
        add(txtName);
        txtName.setBounds(210, 80, 200, 30);
        add(txtUsername);
        txtUsername.setBounds(210, 120, 200, 30);
        add(txtEmail);
        txtEmail.setBounds(210, 160, 200, 30);

        lblEmail.setText("Email:");
        add(lblEmail);
        lblEmail.setBounds(40, 160, 170, 30);
        add(txtPhone);
        txtPhone.setBounds(210, 200, 200, 30);

        lblPhone.setText("Phone:");
        add(lblPhone);
        lblPhone.setBounds(40, 200, 170, 30);

        btnSave.setText("Save");
        btnSave.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSaveActionPerformed(evt);
            }
        });
        add(btnSave);
        btnSave.setBounds(520, 300, 72, 23);
        add(pwPassword);
        pwPassword.setBounds(300, 370, 140, 30);

        lblPassword.setText("Password");
        add(lblPassword);
        lblPassword.setBounds(230, 380, 70, 20);

        lblConfirmPassword.setText("Confirm Password ");
        add(lblConfirmPassword);
        lblConfirmPassword.setBounds(190, 430, 110, 20);
        add(pwConfirmPassword);
        pwConfirmPassword.setBounds(300, 420, 140, 30);

        btnEdit.setText("Edit");
        btnEdit.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnEditActionPerformed(evt);
            }
        });
        add(btnEdit);
        btnEdit.setBounds(210, 300, 72, 23);
        add(txtCreated);
        txtCreated.setBounds(210, 240, 200, 30);

        lblCreated.setText("Created Date");
        add(lblCreated);
        lblCreated.setBounds(40, 250, 80, 16);

        btnSavePw.setText("Save password");
        btnSavePw.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSavePwActionPerformed(evt);
            }
        });
        add(btnSavePw);
        btnSavePw.setBounds(487, 420, 110, 23);

        btnResetPw.setText("Reset Password");
        btnResetPw.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnResetPwActionPerformed(evt);
            }
        });
        add(btnResetPw);
        btnResetPw.setBounds(340, 300, 120, 23);
    }// </editor-fold>//GEN-END:initComponents

    private void Back1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_Back1ActionPerformed
        // TODO add your handling code here:
         CardSequencePanel.remove(this);
        ((java.awt.CardLayout) CardSequencePanel.getLayout()).next(CardSequencePanel);


    }//GEN-LAST:event_Back1ActionPerformed

    private void btnSaveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSaveActionPerformed
        // TODO add your handling code here:
        updateuserinfo();
    }//GEN-LAST:event_btnSaveActionPerformed

    private void btnEditActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnEditActionPerformed
        // Turn fields to editable
        seteditmode();
    }//GEN-LAST:event_btnEditActionPerformed

    private void btnSavePwActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSavePwActionPerformed
        // save password sequence (extract passwords, validate, save)
        savepassword();
    }//GEN-LAST:event_btnSavePwActionPerformed

    private void btnResetPwActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnResetPwActionPerformed
        // Reset password sequence. Turns on hidden fields, sets them to editable.
        resetpassword();
    }//GEN-LAST:event_btnResetPwActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton Back1;
    private javax.swing.JButton btnEdit;
    private javax.swing.JButton btnResetPw;
    private javax.swing.JButton btnSave;
    private javax.swing.JButton btnSavePw;
    private javax.swing.JLabel lblConfirmPassword;
    private javax.swing.JLabel lblCreated;
    private javax.swing.JLabel lblEmail;
    private javax.swing.JLabel lblName;
    private javax.swing.JLabel lblPageTitle;
    private javax.swing.JLabel lblPassword;
    private javax.swing.JLabel lblPhone;
    private javax.swing.JLabel lblUsername;
    private javax.swing.JPasswordField pwConfirmPassword;
    private javax.swing.JPasswordField pwPassword;
    private javax.swing.JTextField txtCreated;
    private javax.swing.JTextField txtEmail;
    private javax.swing.JTextField txtName;
    private javax.swing.JTextField txtPhone;
    private javax.swing.JTextField txtUsername;
    // End of variables declaration//GEN-END:variables

    private void populatefields() {
        Person p = employeeprofile.getPerson();
        
        String name = p.getFullname();
        String username = selecteduseraccount.getUsername();
        String role = employeeprofile.getRole();
        String email = selecteduseraccount.getAssociatedPersonProfile().getEmail();
        String phone = selecteduseraccount.getAssociatedPersonProfile().getPhone();
        
        
        txtName.setText(name);
        txtUsername.setText(username);
        txtEmail.setText(email);
        txtPhone.setText(phone);   
        txtName.setEnabled(false);
        txtUsername.setEnabled(false);
        txtEmail.setEnabled(false); 
        
        //hide password fields
        pwPassword.setVisible(false);
        pwConfirmPassword.setVisible(false);
        lblPassword.setVisible(false);
        lblConfirmPassword.setVisible(false);
        btnSavePw.setVisible(false);
        
    }

    private void resetpassword() {
        pwPassword.setVisible(true);
        pwConfirmPassword.setVisible(true);
        btnSavePw.setVisible(true);
        pwPassword.setEnabled(true);
        pwConfirmPassword.setEnabled(true);
        lblPassword.setVisible(true);
        lblConfirmPassword.setVisible(true);    }

    private void savepassword() {
    char[] passwordChars = pwPassword.getPassword(); 
    char[] confirmChars = pwConfirmPassword.getPassword(); 
    
    if (passwordChars == null || passwordChars.length == 0) { 
        JOptionPane.showMessageDialog(this, "Please enter a password"); 
        return; 
    } 
    if (!Arrays.equals(passwordChars, confirmChars)) { 
        JOptionPane.showMessageDialog(this, "Passwords don't match"); 
        return; 
    } 
    selecteduseraccount.setPassword(new String(passwordChars)); 
    selecteduseraccount.updatelastupdate(); 
    JOptionPane.showMessageDialog(this, "Password updated successfully"); 

     
    }        

    private String formatTimestamp(LocalDateTime timestamp) {
    if (timestamp == null) return "Never";
    DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MM/dd/yyyy h:mm a");
    return timestamp.format(formatter);    
    }    


    private void seteditmode() {
        txtName.setEnabled(true);
        txtUsername.setEnabled(true);
        txtCreated.setEnabled(false);
        txtEmail.setEnabled(true);
        txtPhone.setEnabled(true);
         
    }

    private void updateuserinfo() {
        String name = txtName.getText().trim();
        String username = txtUsername.getText().trim();
        String email = txtEmail.getText().trim();
        String phone = txtPhone.getText().trim();
        String created = txtCreated.getText().trim();

        // Validate required fields
        if (name.isBlank() || username.isBlank() || email.isBlank()) {
            JOptionPane.showMessageDialog(this, "Name, Email, and Username are required");
            return;
        }

        // Verify username is not taken
        
        UserAccount u = business.getUserAccountDirectory().findusername(username);
        if (u != null && u != selecteduseraccount) {
            JOptionPane.showMessageDialog(this, "Username is taken. Please select another username.");
            return;
        }

        // Verify email is not taken
        if (business.getUserAccountDirectory().isEmailTaken(email, selecteduseraccount)) {
            JOptionPane.showMessageDialog(this, "Email is already in use");
            return;
        }

        // Save common fields
        Person person = selecteduseraccount.getAssociatedPersonProfile().getPerson();
        person.setFullname(name);
        selecteduseraccount.setUsername(username);
        selecteduseraccount.getAssociatedPersonProfile().setEmail(email);
        selecteduseraccount.getAssociatedPersonProfile().setPhone(phone);


        // Update timestamp
        selecteduseraccount.updatelastupdate();

        // Navigate back to fresh ManageEmployeesJPanel
        JOptionPane.showMessageDialog(this, "Admin account updated successfully");
        
        
    }

}
